<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• ARV Stock Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { display: none; }
        .modal.show { display: block; }
    </style>
</head>
<body class="bg-blue-600 min-h-screen flex flex-col items-center justify-center p-4">
    <!-- Login Section -->
    <section id="login-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md fade-in">
        <h1 class="text-2xl font-bold text-blue-800 mb-2 text-center">üè• ARV Stock Control System</h1>
        <h2 class="text-lg text-gray-600 mb-4 text-center">Luapula Province, Zambia</h2>
        <form id="loginForm">
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username:</label>
            <input type="text" id="username" name="username" required placeholder="Enter your username" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
            <input type="password" id="password" name="password" required placeholder="Enter your password" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <div id="login-error" class="text-red-500 text-sm mb-3 hidden"></div>
            
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">Login</button>
        </form>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h1 class="text-2xl font-bold text-blue-800 mb-2 text-center">üè• ARV Stock Control System</h1>
        <h2 class="text-lg text-gray-600 mb-4 text-center">Weekly ARV Reporting & HIV Program Monitoring - Luapula Province</h2>
        <form id="logoutForm" class="mb-4">
            <button type="submit" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition">Logout</button>
        </form>
        <nav class="flex flex-wrap gap-2 justify-center">
            <button onclick="showSection('report-section')" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">üìù Submit ARV Report</button>
            <button onclick="showSection('reports-section')" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">üìä View Reports</button>
            <button onclick="showSection('user-management-section')" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">üë• User Management</button>
            <button onclick="showSection('admin-section')" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">‚öôÔ∏è Admin Dashboard</button>
            <button onclick="showSection('analytics-section')" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">üìà Commodity Analytics</button>
        </nav>
    </section>

    <!-- Report Submission Section -->
    <section id="report-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h2 class="text-xl font-bold text-blue-800 mb-4">üìù Weekly ARV Stock & Program Report</h2>
        <button onclick="showSection('dashboard-section')" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition mb-4">Back to Dashboard</button>
        <form id="reportForm">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">üìÖ Report Information</h3>
            <label for="report-week" class="block text-sm font-medium text-gray-700 mb-1">Report Week:</label>
            <input type="week" id="report-week" name="report_week" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="facility-name" class="block text-sm font-medium text-gray-700 mb-1">Facility Name:</label>
            <input type="text" id="facility-name" name="facility_name" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="reporter-name" class="block text-sm font-medium text-gray-700 mb-1">Reporter Name:</label>
            <input type="text" id="reporter-name" name="reporter_name" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">üíä ARV Commodities Stock Report</h3>
            <button type="button" onclick="addCommodityRow('arv-commodities')" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition mb-2">Add ARV Commodity</button>
            <div class="overflow-x-auto">
                <table id="arv-commodities" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-100">
                            <th class="border p-2 text-left">Commodity</th>
                            <th class="border p-2 text-left">Opening Balance</th>
                            <th class="border p-2 text-left">Received</th>
                            <th class="border p-2 text-left">Used</th>
                            <th class="border p-2 text-left">Given Out</th>
                            <th class="border p-2 text-left">Current Balance</th>
                            <th class="border p-2 text-left">Expiry Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2"><input type="text" name="commodities[0][name]" required class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="commodities[0][opening_balance]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="commodities[0][received]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="commodities[0][used]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="commodities[0][given_out]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="commodities[0][current_balance]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="date" name="commodities[0][expiry_date]" required class="w-full p-1 border rounded"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">üß™ HIV Testing Commodities</h3>
            <button type="button" onclick="addCommodityRow('test-commodities')" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition mb-2">Add Test Commodity</button>
            <div class="overflow-x-auto">
                <table id="test-commodities" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-100">
                            <th class="border p-2 text-left">Commodity</th>
                            <th class="border p-2 text-left">Opening Balance</th>
                            <th class="border p-2 text-left">Received</th>
                            <th class="border p-2 text-left">Used</th>
                            <th class="border p-2 text-left">Given Out</th>
                            <th class="border p-2 text-left">Current Balance</th>
                            <th class="border p-2 text-left">Expiry Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2"><input type="text" name="test_commodities[0][name]" required class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="test_commodities[0][opening_balance]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="test_commodities[0][received]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="test_commodities[0][used]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="test_commodities[0][given_out]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="number" name="test_commodities[0][current_balance]" required min="0" class="w-full p-1 border rounded"></td>
                            <td class="border p-2"><input type="date" name="test_commodities[0][expiry_date]" required class="w-full p-1 border rounded"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">üìä HIV Program Metrics</h3>
            <label for="clients-seen" class="block text-sm font-medium text-gray-700 mb-1">Total Clients Seen:</label>
            <input type="number" id="clients-seen" name="clients_seen" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <h4 class="text-md font-semibold text-gray-700 mb-2">Drug Delivery Schedule</h4>
            <label for="due-delivery" class="block text-sm font-medium text-gray-700 mb-1">Due for Drug Delivery:</label>
            <input type="number" id="due-delivery" name="due_delivery" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="mmd-6" class="block text-sm font-medium text-gray-700 mb-1">6MMD (6-month multi-month dispensing):</label>
            <input type="number" id="mmd-6" name="mmd_6" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="mmd-3-5" class="block text-sm font-medium text-gray-700 mb-1">3-5MMD:</label>
            <input type="number" id="mmd-3-5" name="mmd_3_5" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="mmd-less-3" class="block text-sm font-medium text-gray-700 mb-1">Less than 3MMD:</label>
            <input type="number" id="mmd-less-3" name="mmd_less_3" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <h4 class="text-md font-semibold text-gray-700 mb-2">Viral Load Monitoring</h4>
            <label for="vl-due" class="block text-sm font-medium text-gray-700 mb-1">Clients Due for VL:</label>
            <input type="number" id="vl-due" name="vl_due" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="vl-collected" class="block text-sm font-medium text-gray-700 mb-1">VL Collected (from those due):</label>
            <input type="number" id="vl-collected" name="vl_collected" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <h4 class="text-md font-semibold text-gray-700 mb-2">TPT & Community Activities</h4>
            <label for="tpt-initiations" class="block text-sm font-medium text-gray-700 mb-1">TPT Initiations:</label>
            <input type="number" id="tpt-initiations" name="tpt_initiations" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="home-deliveries" class="block text-sm font-medium text-gray-700 mb-1">Home Deliveries:</label>
            <input type="number" id="home-deliveries" name="home_deliveries" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="community-activities" class="block text-sm font-medium text-gray-700 mb-1">Community Activities:</label>
            <input type="number" id="community-activities" name="community_activities" required min="0" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">üìù Additional Information</h3>
            <label for="remarks" class="block text-sm font-medium text-gray-700 mb-1">Remarks/Notes:</label>
            <textarea id="remarks" name="remarks" rows="4" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            
            <div id="report-error" class="text-red-500 text-sm mb-3 hidden"></div>
            
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">üíæ Submit Complete ARV Report</button>
        </form>
    </section>

    <!-- View Reports Section -->
    <section id="reports-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h2 class="text-xl font-bold text-blue-800 mb-4">üìä ARV Stock Reports</h2>
        <button onclick="showSection('dashboard-section')" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition mb-4">Back to Dashboard</button>
        <div class="overflow-x-auto">
            <table id="reports-table" class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-2 text-left">Week</th>
                        <th class="border p-2 text-left">Hub</th>
                        <th class="border p-2 text-left">Facility</th>
                        <th class="border p-2 text-left">Reporter</th>
                        <th class="border p-2 text-left">Clients Seen</th>
                        <th class="border p-2 text-left">Due for Delivery</th>
                        <th class="border p-2 text-left">6MMD</th>
                        <th class="border p-2 text-left">3-5MMD</th>
                        <th class="border p-2 text-left">VL Due</th>
                        <th class="border p-2 text-left">VL Collected</th>
                        <th class="border p-2 text-left">TPT Initiations</th>
                        <th class="border p-2 text-left">Submitted</th>
                    </tr>
                </thead>
                <tbody id="reports-table-body">
                    <tr>
                        <td colspan="12" class="border p-2 text-center">No reports submitted yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- User Management Section -->
    <section id="user-management-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h2 class="text-xl font-bold text-blue-800 mb-4">üë• User Management</h2>
        <button onclick="showSection('create-user-modal')" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition mb-4">‚ûï Create New User</button>
        <button onclick="showSection('dashboard-section')" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition mb-4">Back to Dashboard</button>
        <div class="overflow-x-auto">
            <table id="users-table" class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-2 text-left">Name</th>
                        <th class="border p-2 text-left">Email</th>
                        <th class="border p-2 text-left">Hub</th>
                        <th class="border p-2 text-left">Facility</th>
                        <th class="border p-2 text-left">Role</th>
                        <th class="border p-2 text-left">Status</th>
                        <th class="border p-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Populated dynamically -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Admin Dashboard Section -->
    <section id="admin-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h2 class="text-xl font-bold text-blue-800 mb-4">‚öôÔ∏è Provincial Administrator Dashboard</h2>
        <button onclick="showSection('dashboard-section')" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition mb-4">Back to Dashboard</button>
        <div class="overflow-x-auto">
            <table id="admin-reports-table" class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-2 text-left">Week</th>
                        <th class="border p-2 text-left">Hub</th>
                        <th class="border p-2 text-left">Facility</th>
                        <th class="border p-2 text-left">Reporter</th>
                        <th class="border p-2 text-left">Clients Seen</th>
                        <th class="border p-2 text-left">Due Delivery</th>
                        <th class="border p-2 text-left">6MMD</th>
                        <th class="border p-2 text-left">3-5MMD</th>
                        <th class="border p-2 text-left">VL Due</th>
                        <th class="border p-2 text-left">VL Collected</th>
                        <th class="border p-2 text-left">TPT</th>
                        <th class="border p-2 text-left">Home Del.</th>
                        <th class="border p-2 text-left">Community</th>
                        <th class="border p-2 text-left">Submitted</th>
                        <th class="border p-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-reports-table-body">
                    <tr>
                        <td colspan="15" class="border p-2 text-center">No reports available</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Commodity Analytics Section -->
    <section id="analytics-section" class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl hidden fade-in">
        <h2 class="text-xl font-bold text-blue-800 mb-4">üìà Commodity Analytics</h2>
        <button onclick="showSection('dashboard-section')" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition mb-4">Back to Dashboard</button>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">üíä ARV Commodities</h3>
        <div class="overflow-x-auto mb-4">
            <table id="arv-analytics-table" class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-2 text-left">Commodity</th>
                        <th class="border p-2 text-left">Total Current Balance</th>
                        <th class="border p-2 text-left">Expiring Soon</th>
                    </tr>
                </thead>
                <tbody id="arv-analytics-table-body">
                    <tr>
                        <td colspan="3" class="border p-2 text-center">No ARV commodities reported</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">üß™ HIV Testing Commodities</h3>
        <div class="overflow-x-auto">
            <table id="test-analytics-table" class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="border p-2 text-left">Commodity</th>
                        <th class="border p-2 text-left">Total Current Balance</th>
                        <th class="border p-2 text-left">Expiring Soon</th>
                    </tr>
                </thead>
                <tbody id="test-analytics-table-body">
                    <tr>
                        <td colspan="3" class="border p-2 text-center">No test commodities reported</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Create User Modal -->
    <section id="create-user-modal" class="modal bg-white rounded-lg shadow-lg p-6 w-full max-w-md fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
        <h2 class="text-xl font-bold text-blue-800 mb-4">√ó Create New User Account</h2>
        <form id="createUserForm">
            <label for="full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name:</label>
            <input type="text" id="full-name" name="full_name" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">Username:</label>
            <input type="text" id="new-username" name="username" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
            <input type="email" id="email" name="email" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="hub" class="block text-sm font-medium text-gray-700 mb-1">Hub:</label>
            <select id="hub" name="hub" required onchange="updateFacilities()" class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select Hub</option>
                <option value="Mansa">Mansa Hub</option>
                <option value="Kawambwa">Kawambwa Hub</option>
                <option value="Samfya">Samfya Hub</option>
                <option value="Nchelenge">Nchelenge Hub</option>
            </select>
            
            <label for="facility" class="block text-sm font-medium text-gray-700 mb-1">Facility:</label>
            <select id="facility" name="facility" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">First select hub</option>
            </select>
            
            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
            <input type="password" id="new-password" name="password" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Role:</label>
            <select id="role" name="role" required class="w-full p-2 border rounded-md mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="facility_user">Facility User</option>
                <option value="administrator">Administrator</option>
            </select>
            
            <div id="create-user-error" class="text-red-500 text-sm mb-3 hidden"></div>
            
            <div class="flex gap-2">
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition">Create User Account</button>
                <button type="button" onclick="hideModal()" class="w-full bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 transition">Cancel</button>
            </div>
        </form>
    </section>

    <script>
        // Initialize localStorage for reports and users
        let reports = JSON.parse(localStorage.getItem('reports')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'Adminkeegan', password: 'Job1@hon', full_name: 'Admin Keegan', email: 'admin@example.com', hub: 'Mansa', facility: 'Mansa Hospital', role: 'administrator' }
        ];

        // Section navigation
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('fade-in');
            });
            const target = document.getElementById(sectionId);
            target.classList.remove('hidden');
            target.classList.add('fade-in');
            if (sectionId === 'create-user-modal') {
                target.classList.add('show');
            } else {
                hideModal();
            }
            if (sectionId === 'reports-section' || sectionId === 'admin-section') {
                populateReports();
            }
            if (sectionId === 'user-management-section') {
                populateUsers();
            }
            if (sectionId === 'analytics-section') {
                populateAnalytics();
            }
        }

        function hideModal() {
            document.getElementById('create-user-modal').classList.remove('show');
        }

        // Facility population
        function updateFacilities() {
            const hub = document.getElementById('hub').value;
            const facilitySelect = document.getElementById('facility');
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            const facilities = {
                'Mansa': ['Mansa Hospital', 'Mansa Clinic'],
                'Kawambwa': ['Kawambwa Health Center'],
                'Samfya': ['Samfya Clinic'],
                'Nchelenge': ['Nchelenge Hospital']
            };
            if (facilities[hub]) {
                facilities[hub].forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility;
                    option.textContent = facility;
                    facilitySelect.appendChild(option);
                });
            }
        }

        // Add commodity row
        function addCommodityRow(tableId) {
            const table = document.getElementById(tableId).querySelector('tbody');
            const index = table.children.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="border p-2"><input type="text" name="${tableId}[${index}][name]" required class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="number" name="${tableId}[${index}][opening_balance]" required min="0" class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="number" name="${tableId}[${index}][received]" required min="0" class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="number" name="${tableId}[${index}][used]" required min="0" class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="number" name="${tableId}[${index}][given_out]" required min="0" class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="number" name="${tableId}[${index}][current_balance]" required min="0" class="w-full p-1 border rounded"></td>
                <td class="border p-2"><input type="date" name="${tableId}[${index}][expiry_date]" required class="w-full p-1 border rounded"></td>
            `;
            table.appendChild(row);
        }

        // Populate reports table
        function populateReports() {
            const reportsTableBody = document.getElementById('reports-table-body');
            const adminReportsTableBody = document.getElementById('admin-reports-table-body');
            reportsTableBody.innerHTML = '';
            adminReportsTableBody.innerHTML = '';
            
            if (reports.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="12" class="border p-2 text-center">No reports submitted yet</td></tr>';
                adminReportsTableBody.innerHTML = '<tr><td colspan="15" class="border p-2 text-center">No reports available</td></tr>';
                return;
            }

            reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${report.week}</td>
                    <td class="border p-2">${report.hub || 'N/A'}</td>
                    <td class="border p-2">${report.facility}</td>
                    <td class="border p-2">${report.reporter}</td>
                    <td class="border p-2">${report.clients_seen}</td>
                    <td class="border p-2">${report.due_delivery}</td>
                    <td class="border p-2">${report.mmd_6}</td>
                    <td class="border p-2">${report.mmd_3_5}</td>
                    <td class="border p-2">${report.vl_due}</td>
                    <td class="border p-2">${report.vl_collected}</td>
                    <td class="border p-2">${report.tpt_initiations}</td>
                    <td class="border p-2">${new Date(report.submitted).toLocaleString()}</td>
                `;
                reportsTableBody.appendChild(row);

                const adminRow = document.createElement('tr');
                adminRow.innerHTML = `
                    <td class="border p-2">${report.week}</td>
                    <td class="border p-2">${report.hub || 'N/A'}</td>
                    <td class="border p-2">${report.facility}</td>
                    <td class="border p-2">${report.reporter}</td>
                    <td class="border p-2">${report.clients_seen}</td>
                    <td class="border p-2">${report.due_delivery}</td>
                    <td class="border p-2">${report.mmd_6}</td>
                    <td class="border p-2">${report.mmd_3_5}</td>
                    <td class="border p-2">${report.vl_due}</td>
                    <td class="border p-2">${report.vl_collected}</td>
                    <td class="border p-2">${report.tpt_initiations}</td>
                    <td class="border p-2">${report.home_deliveries}</td>
                    <td class="border p-2">${report.community_activities}</td>
                    <td class="border p-2">${new Date(report.submitted).toLocaleString()}</td>
                    <td class="border p-2"><button onclick="deleteReport('${report.id}')" class="text-red-500 hover:underline">Delete</button></td>
                `;
                adminReportsTableBody.appendChild(adminRow);
            });
        }

        // Populate users table
        function populateUsers() {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';
            
            if (users.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="7" class="border p-2 text-center">No users created yet</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${user.full_name}</td>
                    <td class="border p-2">${user.email}</td>
                    <td class="border p-2">${user.hub}</td>
                    <td class="border p-2">${user.facility}</td>
                    <td class="border p-2">${user.role === 'administrator' ? 'Administrator' : 'Facility User'}</td>
                    <td class="border p-2">Active</td>
                    <td class="border p-2"><button onclick="deleteUser('${user.username}')" class="text-red-500 hover:underline">Delete</button></td>
                `;
                usersTableBody.appendChild(row);
            });
        }

        // Populate commodity analytics
        function populateAnalytics() {
            const arvTableBody = document.getElementById('arv-analytics-table-body');
            const testTableBody = document.getElementById('test-analytics-table-body');
            arvTableBody.innerHTML = '';
            testTableBody.innerHTML = '';
            
            const arvCommodities = {};
            const testCommodities = {};
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            reports.forEach(report => {
                (report.commodities || []).forEach(commodity => {
                    if (!arvCommodities[commodity.name]) {
                        arvCommodities[commodity.name] = { total: 0, expiring: [] };
                    }
                    arvCommodities[commodity.name].total += parseInt(commodity.current_balance) || 0;
                    if (commodity.expiry_date && new Date(commodity.expiry_date) <= thirtyDaysFromNow) {
                        arvCommodities[commodity.name].expiring.push({
                            expiry_date: commodity.expiry_date,
                            quantity: commodity.current_balance,
                            facility: report.facility
                        });
                    }
                });
                (report.test_commodities || []).forEach(commodity => {
                    if (!testCommodities[commodity.name]) {
                        testCommodities[commodity.name] = { total: 0, expiring: [] };
                    }
                    testCommodities[commodity.name].total += parseInt(commodity.current_balance) || 0;
                    if (commodity.expiry_date && new Date(commodity.expiry_date) <= thirtyDaysFromNow) {
                        testCommodities[commodity.name].expiring.push({
                            expiry_date: commodity.expiry_date,
                            quantity: commodity.current_balance,
                            facility: report.facility
                        });
                    }
                });
            });

            if (Object.keys(arvCommodities).length === 0) {
                arvTableBody.innerHTML = '<tr><td colspan="3" class="border p-2 text-center">No ARV commodities reported</td></tr>';
            } else {
                Object.keys(arvCommodities).forEach(name => {
                    const row = document.createElement('tr');
                    const expiringText = arvCommodities[name].expiring.map(exp => `${exp.quantity} at ${exp.facility} (Expires: ${exp.expiry_date})`).join('; ') || 'None';
                    row.innerHTML = `
                        <td class="border p-2">${name}</td>
                        <td class="border p-2">${arvCommodities[name].total}</td>
                        <td class="border p-2">${expiringText}</td>
                    `;
                    arvTableBody.appendChild(row);
                });
            }

            if (Object.keys(testCommodities).length === 0) {
                testTableBody.innerHTML = '<tr><td colspan="3" class="border p-2 text-center">No test commodities reported</td></tr>';
            } else {
                Object.keys(testCommodities).forEach(name => {
                    const row = document.createElement('tr');
                    const expiringText = testCommodities[name].expiring.map(exp => `${exp.quantity} at ${exp.facility} (Expires: ${exp.expiry_date})`).join('; ') || 'None';
                    row.innerHTML = `
                        <td class="border p-2">${name}</td>
                        <td class="border p-2">${testCommodities[name].total}</td>
                        <td class="border p-2">${expiringText}</td>
                    `;
                    testTableBody.appendChild(row);
                });
            }
        }

        // Delete report
        function deleteReport(id) {
            reports = reports.filter(report => report.id !== id);
            localStorage.setItem('reports', JSON.stringify(reports));
            populateReports();
            populateAnalytics();
        }

        // Delete user
        function deleteUser(username) {
            users = users.filter(user => user.username !== username);
            localStorage.setItem('users', JSON.stringify(users));
            populateUsers();
        }

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            const user = users.find(u => u.username === username && u.password === password);
            if (user || (username === 'Adminkeegan' && password === 'Job1@hon')) {
                showSection('dashboard-section');
            } else {
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.classList.remove('hidden');
            }
        });

        // Logout form submission
        document.getElementById('logoutForm').addEventListener('submit', (e) => {
            e.preventDefault();
            showSection('login-section');
        });

        // Report form submission
        document.getElementById('reportForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('reportForm'));
            const commodities = [];
            const testCommodities = [];
            
            // Collect commodities
            document.querySelectorAll('#arv-commodities tbody tr').forEach((row, index) => {
                commodities.push({
                    name: formData.get(`commodities[${index}][name]`),
                    opening_balance: formData.get(`commodities[${index}][opening_balance]`),
                    received: formData.get(`commodities[${index}][received]`),
                    used: formData.get(`commodities[${index}][used]`),
                    given_out: formData.get(`commodities[${index}][given_out]`),
                    current_balance: formData.get(`commodities[${index}][current_balance]`),
                    expiry_date: formData.get(`commodities[${index}][expiry_date]`)
                });
            });
            
            // Collect test commodities
            document.querySelectorAll('#test-commodities tbody tr').forEach((row, index) => {
                testCommodities.push({
                    name: formData.get(`test_commodities[${index}][name]`),
                    opening_balance: formData.get(`test_commodities[${index}][opening_balance]`),
                    received: formData.get(`test_commodities[${index}][received]`),
                    used: formData.get(`test_commodities[${index}][used]`),
                    given_out: formData.get(`test_commodities[${index}][given_out]`),
                    current_balance: formData.get(`test_commodities[${index}][current_balance]`),
                    expiry_date: formData.get(`test_commodities[${index}][expiry_date]`)
                });
            });

            const report = {
                id: Date.now().toString(),
                week: formData.get('report_week'),
                hub: formData.get('hub') || 'N/A',
                facility: formData.get('facility_name'),
                reporter: formData.get('reporter_name'),
                clients_seen: formData.get('clients_seen'),
                due_delivery: formData.get('due_delivery'),
                mmd_6: formData.get('mmd_6'),
                mmd_3_5: formData.get('mmd_3_5'),
                mmd_less_3: formData.get('mmd_less_3'),
                vl_due: formData.get('vl_due'),
                vl_collected: formData.get('vl_collected'),
                tpt_initiations: formData.get('tpt_initiations'),
                home_deliveries: formData.get('home_deliveries'),
                community_activities: formData.get('community_activities'),
                remarks: formData.get('remarks'),
                commodities,
                test_commodities: testCommodities,
                submitted: new Date().toISOString()
            };
            reports.push(report);
            localStorage.setItem('reports', JSON.stringify(reports));
            alert('Report submitted successfully');
            document.getElementById('reportForm').reset();
            showSection('reports-section');
        });

        // Create user form submission
        document.getElementById('createUserForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(document.getElementById('createUserForm'));
            const username = formData.get('username');
            const errorDiv = document.getElementById('create-user-error');
            
            if (users.some(u => u.username === username)) {
                errorDiv.textContent = 'Username already exists';
                errorDiv.classList.remove('hidden');
                return;
            }

            const user = {
                full_name: formData.get('full_name'),
                username,
                password: formData.get('password'),
                email: formData.get('email'),
                hub: formData.get('hub'),
                facility: formData.get('facility'),
                role: formData.get('role')
            };
            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            alert('User created successfully');
            document.getElementById('createUserForm').reset();
            hideModal();
            showSection('user-management-section');
        });

        // Initialize tables on page load
        document.addEventListener('DOMContentLoaded', () => {
            localStorage.setItem('users', JSON.stringify(users)); // Ensure default admin user is saved
            populateReports();
            populateUsers();
        });
    </script>
</body>
</html>