<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Stock Control System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 20px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s ease;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-low {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-normal {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-expired {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters > div {
            min-width: 200px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .setup-instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .setup-instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .setup-instructions code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d32f2f;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Configuration Notice -->
    <div id="configNotice" class="login-container">
        <div class="setup-instructions">
            <h3>🔧 Firebase Setup Required</h3>
            <p><strong>To make this system work online, you need to:</strong></p>
            <ol style="margin: 15px 0; padding-left: 20px;">
                <li>Create a Firebase project at <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
                <li>Enable Authentication and Firestore Database</li>
                <li>Copy your Firebase config and replace the placeholder below</li>
                <li>Deploy this file to Firebase Hosting</li>
            </ol>
            <p><strong>Current Status:</strong> <span style="color: #d32f2f;">⚠️ Demo Mode (data won't persist)</span></p>
        </div>
        <button class="btn" onclick="proceedToDemo()">Continue with Demo</button>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container hidden">
        <div class="login-header">
            <h2>🏥 Medical Stock Control</h2>
            <p>Please log in to continue</p>
            <div id="connectionStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>
        
        <!-- Admin Login -->
        <div id="adminLogin">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Administrator Login</h3>
            <div class="form-group">
                <label for="adminEmail">Email:</label>
                <input type="email" id="adminEmail" placeholder="admin@hospital.com" value="admin@medical.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Password" value="admin123">
            </div>
            <button class="btn" onclick="loginAsAdmin()" id="adminLoginBtn">
                <span class="loading hidden"></span>Login as Admin
            </button>
        </div>
        
        <div style="text-align: center; margin: 20px 0; color: #666;">OR</div>
        
        <!-- Facility Login -->
        <div id="facilityLogin">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">Facility User Login</h3>
            <div class="form-group">
                <label for="facilitySelect">Select Your Facility:</label>
                <select id="facilitySelect">
                    <option value="">Choose your facility</option>
                    <option value="Central Hospital">Central Hospital</option>
                    <option value="District Health Center">District Health Center</option>
                    <option value="Community Clinic A">Community Clinic A</option>
                    <option value="Community Clinic B">Community Clinic B</option>
                    <option value="Maternity Ward">Maternity Ward</option>
                    <option value="Pediatric Center">Pediatric Center</option>
                    <option value="Emergency Unit">Emergency Unit</option>
                </select>
            </div>
            <div class="form-group">
                <label for="facilityPassword">Facility Password:</label>
                <input type="password" id="facilityPassword" placeholder="Facility Password" value="facility123">
            </div>
            <button class="btn" onclick="loginAsFacility()" id="facilityLoginBtn">
                <span class="loading hidden"></span>Login to Facility
            </button>
        </div>
        
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAt_dmYx_ulAqLr1srzprbh4K27aSQCGYs",
  authDomain: "medical-stock-control-e369c.firebaseapp.com",
  projectId: "medical-stock-control-e369c",
  storageBucket: "medical-stock-control-e369c.firebasestorage.app",
  messagingSenderId: "202713009439",
  appId: "1:202713009439:web:bdd6ce642435342608f42a",
  measurementId: "G-8VFJRDHWJ1"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>🏥 Medical Stock Control System</h1>
            <p>Weekly Reporting & Inventory Management</p>
            <div style="margin-top: 20px;">
                <span id="currentUser" style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px;"></span>
                <button class="btn" onclick="logout()" style="margin-left: 15px; padding: 8px 16px; font-size: 0.9em;">Logout</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('submit', this)">📝 Submit Report</button>
            <button class="nav-tab" onclick="showTab('view', this)" id="viewTab">📊 View Reports</button>
            <button class="nav-tab hidden" onclick="showTab('admin', this)" id="adminTab">⚙️ Admin Dashboard</button>
        </div>

        <!-- Submit Report Tab -->
        <div id="submit" class="tab-content active">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">📝 Submit Weekly Stock Report</h2>
            
            <form id="stockForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reportWeek">Report Week:</label>
                        <input type="week" id="reportWeek" required>
                    </div>
                    <div class="form-group">
                        <label for="commodity">Commodity Name:</label>
                        <input type="text" id="commodity" placeholder="e.g., Paracetamol 500mg" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date:</label>
                        <input type="date" id="expiryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="openingBalance">Opening Balance:</label>
                        <input type="number" id="openingBalance" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="received">Received:</label>
                        <input type="number" id="received" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="used">Used:</label>
                        <input type="number" id="used" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="givenToOthers">Given to Other Facilities:</label>
                        <input type="number" id="givenToOthers" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="balance">Current Balance:</label>
                        <input type="number" id="balance" placeholder="0" min="0" readonly>
                    </div>
                    <div class="form-group">
                        <label for="remarks">Remarks/Notes:</label>
                        <textarea id="remarks" rows="3" placeholder="Any additional notes..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" id="submitBtn">
                    <span class="loading hidden"></span>💾 Submit Report
                </button>
            </form>
        </div>

        <!-- View Reports Tab -->
        <div id="view" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">📊 Stock Reports</h2>
            
            <div class="filters">
                <div class="form-group">
                    <label for="filterWeek">Filter by Week:</label>
                    <input type="week" id="filterWeek">
                </div>
                <div class="form-group">
                    <label for="filterCommodity">Filter by Commodity:</label>
                    <input type="text" id="filterCommodity" placeholder="Search commodity...">
                </div>
                <div>
                    <button class="btn" onclick="applyFilters()">🔍 Apply Filters</button>
                    <button class="btn" onclick="clearFilters()">🗑️ Clear</button>
                    <button class="btn" onclick="refreshReports()">🔄 Refresh</button>
                </div>
            </div>

            <div class="table-container">
                <table id="reportsTable">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Facility</th>
                            <th>Commodity</th>
                            <th>Expiry Date</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Used</th>
                            <th>Given Out</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Submitted</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <tr><td colspan="11" style="text-align: center; color: #666;">Loading reports...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Dashboard Tab -->
        <div id="admin" class="tab-content">
            <h2 style="margin-bottom: 30px; color: #2c3e50;">⚙️ Administrator Dashboard</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalFacilities">-</h3>
                    <p>Active Facilities</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                    <h3 id="totalReports">-</h3>
                    <p>Total Reports</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <h3 id="lowStockItems">-</h3>
                    <p>Low Stock Alerts</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <h3 id="expiredItems">-</h3>
                    <p>Expired Items</p>
                </div>
            </div>

            <div class="filters">
                <div class="form-group">
                    <label for="adminFilterFacility">Filter by Facility:</label>
                    <select id="adminFilterFacility">
                        <option value="">All Facilities</option>
                        <option value="Central Hospital">Central Hospital</option>
                        <option value="District Health Center">District Health Center</option>
                        <option value="Community Clinic A">Community Clinic A</option>
                        <option value="Community Clinic B">Community Clinic B</option>
                        <option value="Maternity Ward">Maternity Ward</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adminFilterDateFrom">From Date:</label>
                    <input type="week" id="adminFilterDateFrom">
                </div>
                <div class="form-group">
                    <label for="adminFilterDateTo">To Date:</label>
                    <input type="week" id="adminFilterDateTo">
                </div>
                <div>
                    <button class="btn" onclick="generateAdminReport()">📋 Generate Report</button>
                    <button class="btn btn-success" onclick="exportData()">📤 Export Excel</button>
                </div>
            </div>

            <div class="table-container">
                <table id="adminReportsTable">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Facility</th>
                            <th>Commodity</th>
                            <th>Expiry Date</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Used</th>
                            <th>Given Out</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminReportsTableBody">
                        <tr><td colspan="12" style="text-align: center; color: #666;">Loading admin reports...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (REPLACE WITH YOUR CONFIG)
        const firebaseConfig = {
            // 🔥 REPLACE THESE WITH YOUR FIREBASE PROJECT SETTINGS
            apiKey: "demo-api-key",
            authDomain: "demo-project.firebaseapp.com",
            projectId: "demo-project",
            storageBucket: "demo-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "demo-app-id"
        };

        // Global variables
        let currentUser = null;
        let currentUserType = '';
        let currentFacility = '';
        let db = null;
        let auth = null;
        let isFirebaseConnected = false;

        // Initialize Firebase
        function initFirebase() {
            try {
                if (firebaseConfig.apiKey === "demo-api-key") {
                    console.log("Demo mode - Firebase not configured");
                    initDemoMode();
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                isFirebaseConnected = true;
                
                document.getElementById('connectionStatus').innerHTML = 
                    '<span style="color: #27ae60;">✅ Connected to Firebase</span>';
                
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('connectionStatus').innerHTML = 
                    '<span style="color: #e74c3c;">❌ Firebase connection failed</span>';
                initDemoMode();
            }
        }

        // Demo mode with sample data
        let demoReports = [
            {
                id: 'demo1',
                week: '2024-W31',
                facility: 'Central Hospital',
                commodity: 'Paracetamol 500mg',
                expiryDate: '2025-06-15',
                openingBalance: 500,
                received: 200,
                used: 150,
                givenToOthers: 50,
                balance: 500,
                remarks: 'Stock adequate',
                submittedDate: new Date('2024-08-01T10:30:00').toISOString(),
                submittedBy: 'Central Hospital'
            },
            {
                id: 'demo2',
                week: '2024-W31',
                facility: 'District Health Center',
                commodity: 'Amoxicillin 250mg',
                expiryDate: '2024-12-30',
                openingBalance: 100,
                received: 0,
                used: 80,
                givenToOthers: 0,
                balance: 20,
                remarks: 'Running low',
                submittedDate: new Date('2024-08-01T14:15:00').toISOString(),
                submittedBy: 'District Health Center'
            }
        ];

        function initDemoMode() {
            console.log("Running in demo mode");
            document.getElementById('connectionStatus').innerHTML = 
                '<span style="color: #f39c12;">⚠️ Demo Mode - Data won\'t persist</span>';
        }

        function proceedToDemo() {
            document.getElementById('configNotice').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            initFirebase();
            setCurrentWeek();
            calculateBalance();
        }

        // Authentication functions
        async function loginAsAdmin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('adminLoginBtn');
            const loading = loginBtn.querySelector('.loading');

            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }

            loading.classList.remove('hidden');
            loginBtn.disabled = true;

            try {
                if (isFirebaseConnected) {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;
                } else {
                    // Demo login
                    if (email === 'admin@medical.com' && password === 'admin123') {
                        currentUser = { email: email, uid: 'demo-admin' };
                    } else {
                        throw new Error('Invalid demo credentials');
                    }
                }

                currentUserType = 'admin';
                currentFacility = '';
                showMainApp();
                
            } catch (error) {
                console.error('Admin login error:', error);
                showAlert('Login failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
                loginBtn.disabled = false;
            }
        }

        async function loginAsFacility() {
            const facility = document.getElementById('facilitySelect').value;
            const password = document.getElementById('facilityPassword').value;
            const loginBtn = document.getElementById('facilityLoginBtn');
            const loading = loginBtn.querySelector('.loading');

            if (!facility || !password) {
                showAlert('Please select facility and enter password', 'error');
                return;
            }

            loading.classList.remove('hidden');
            loginBtn.disabled = true;

            try {
                if (isFirebaseConnected) {
                    // In a real app, you'd authenticate facility users differently
                    // For now, we'll create a demo user
                    const email = facility.toLowerCase().replace(/\s+/g, '') + '@facility.com';
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                        currentUser = userCredential.user;
                    } catch (error) {
                        // If user doesn't exist in demo, create them
                        if (password === 'facility123') {
                            currentUser = { email: email, uid: 'demo-' + facility };
                        } else {
                            throw new Error('Invalid facility password');
                        }
                    }
                } else {
                    // Demo login
                    if (password === 'facility123') {
                        currentUser = { email: facility + '@facility.com', uid: 'demo-' + facility };
                    } else {
                        throw new Error('Invalid demo password');
                    }
                }

                currentUserType = 'facility';
                currentFacility = facility;
                showMainApp();
                
            } catch (error) {
                console.error('Facility login error:', error);
                showAlert('Login failed: ' + error.message, 'error');
            } finally {
                loading.classList.add('hidden');
                loginBtn.disabled = false;
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            // Update UI based on user type
            if (currentUserType === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
                document.getElementById('currentUser').textContent = 'Administrator';
            } else {
                document.getElementById('adminTab').classList.add('hidden');
                document.getElementById('currentUser').textContent = `${currentFacility} User`;
            }

            // Load initial data
            loadReports();
        }

        function logout() {
            if (isFirebaseConnected && auth.currentUser) {
                auth.signOut();
            }
            
            currentUser = null;
            currentUserType = '';
            currentFacility = '';
            
            // Reset forms
            document.getElementById('adminEmail').value = 'admin@medical.com';
            document.getElementById('adminPassword').value = 'admin123';
            document.getElementById('facilitySelect').value = '';
            document.getElementById('facilityPassword').value = 'facility123';
            
            // Show login screen
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Reset to submit tab
            showTab('submit', document.querySelector('.nav-tab'));
        }

        // Utility functions
        function setCurrentWeek() {
            const now = new Date();
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            document.getElementById('reportWeek').value = `${year}-W${week.toString().padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Tab functionality
        function showTab(tabName, tabButton) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.nav-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab and mark button as active
            document.getElementById(tabName).classList.add('active');
            tabButton.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'view') {
                loadReports();
            } else if (tabName === 'admin') {
                loadAdminData();
            }
        }

        // Balance calculation
        function calculateBalance() {
            const inputs = ['openingBalance', 'received', 'used', 'givenToOthers'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateBalance);
            });
        }

        function updateBalance() {
            const opening = parseInt(document.getElementById('openingBalance').value) || 0;
            const received = parseInt(document.getElementById('received').value) || 0;
            const used = parseInt(document.getElementById('used').value) || 0;
            const given = parseInt(document.getElementById('givenToOthers').value) || 0;
            
            const balance = opening + received - used - given;
            document.getElementById('balance').value = Math.max(0, balance);
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('stockForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submitBtn');
                const loading = submitBtn.querySelector('.loading');
                
                loading.classList.remove('hidden');
                submitBtn.disabled = true;
                
                try {
                    const formData = {
                        week: document.getElementById('reportWeek').value,
                        facility: currentFacility,
                        commodity: document.getElementById('commodity').value,
                        expiryDate: document.getElementById('expiryDate').value,
                        openingBalance: parseInt(document.getElementById('openingBalance').value),
                        received: parseInt(document.getElementById('received').value),
                        used: parseInt(document.getElementById('used').value),
                        givenToOthers: parseInt(document.getElementById('givenToOthers').value),
                        balance: parseInt(document.getElementById('balance').value),
                        remarks: document.getElementById('remarks').value,
                        submittedDate: new Date().toISOString(),
                        submittedBy: currentFacility
                    };

                    if (isFirebaseConnected) {
                        // Save to Firestore
                        await db.collection('reports').add(formData);
                    } else {
                        // Save to demo data
                        formData.id = 'demo' + Date.now();
                        demoReports.unshift(formData);
                    }
                    
                    showAlert('Report submitted successfully!', 'success');
                    
                    // Reset form
                    this.reset();
                    setCurrentWeek();
                    document.getElementById('balance').value = '';
                    
                } catch (error) {
                    console.error('Submit error:', error);
                    showAlert('Error submitting report: ' + error.message, 'error');
                } finally {
                    loading.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            });
        });

        // Load and display reports
        async function loadReports() {
            try {
                let reports = [];
                
                if (isFirebaseConnected) {
                    // Load from Firestore
                    let query = db.collection('reports').orderBy('submittedDate', 'desc');
                    
                    // Filter by facility for non-admin users  
                    if (currentUserType === 'facility') {
                        query = query.where('facility', '==', currentFacility);
                    }
                    
                    const snapshot = await query.get();
                    reports = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } else {
                    // Load from demo data
                    reports = [...demoReports];
                    if (currentUserType === 'facility') {
                        reports = reports.filter(report => report.facility === currentFacility);
                    }
                }
                
                displayReports(reports);
                
                if (currentUserType === 'admin') {
                    updateAdminStats(reports);
                }
                
            } catch (error) {
                console.error('Load reports error:', error);
                showAlert('Error loading reports: ' + error.message, 'error');
            }
        }

        function displayReports(reports) {
            const tbody = document.getElementById('reportsTableBody');
            const adminTbody = document.getElementById('adminReportsTableBody');
            
            // Clear existing rows
            if (tbody) tbody.innerHTML = '';
            if (adminTbody) adminTbody.innerHTML = '';
            
            if (reports.length === 0) {
                const noDataRow = '<tr><td colspan="12" style="text-align: center; color: #666;">No reports found</td></tr>';
                if (tbody) tbody.innerHTML = noDataRow;
                if (adminTbody) adminTbody.innerHTML = noDataRow;
                return;
            }
            
            reports.forEach(report => {
                const row = createReportRow(report, currentUserType === 'admin');
                if (tbody) tbody.appendChild(row.cloneNode(true));
                if (adminTbody) adminTbody.appendChild(row);
            });
        }

        function createReportRow(report, isAdmin = false) {
            const row = document.createElement('tr');
            
            const status = getStockStatus(report.balance, report.expiryDate);
            const statusClass = `status-${status}`;
            const submittedDate = new Date(report.submittedDate).toLocaleDateString();
            
            row.innerHTML = `
                <td>${report.week}</td>
                <td>${report.facility}</td>
                <td>${report.commodity}</td>
                <td>${report.expiryDate}</td>
                <td>${report.openingBalance}</td>
                <td>${report.received}</td>
                <td>${report.used}</td>
                <td>${report.givenToOthers}</td>
                <td>${report.balance}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>${submittedDate}</td>
                ${isAdmin ? `<td><button class="btn btn-danger" onclick="deleteReport('${report.id}')">Delete</button></td>` : ''}
            `;
            
            return row;
        }

        function getStockStatus(balance, expiryDate) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const daysUntilExpiry = (expiry - today) / (1000 * 60 * 60 * 24);
            
            if (daysUntilExpiry < 0) return 'expired';
            if (balance < 50) return 'low';
            return 'normal';
        }

        // Admin functions
        function loadAdminData() {
            if (currentUserType === 'admin') {
                loadReports();
            }
        }

        function updateAdminStats(reports = null) {
            if (!reports) {
                // If no reports provided, we'll use placeholder values
                document.getElementById('totalFacilities').textContent = '7';
                document.getElementById('totalReports').textContent = demoReports.length;
                document.getElementById('lowStockItems').textContent = '2';
                document.getElementById('expiredItems').textContent = '1';
                return;
            }
            
            const facilities = [...new Set(reports.map(r => r.facility))];
            const lowStockItems = reports.filter(r => getStockStatus(r.balance, r.expiryDate) === 'low').length;
            const expiredItems = reports.filter(r => getStockStatus(r.balance, r.expiryDate) === 'expired').length;
            
            document.getElementById('totalFacilities').textContent = facilities.length;
            document.getElementById('totalReports').textContent = reports.length;
            document.getElementById('lowStockItems').textContent = lowStockItems;
            document.getElementById('expiredItems').textContent = expiredItems;
        }

        async function generateAdminReport() {
            const facilityFilter = document.getElementById('adminFilterFacility').value;
            const dateFromFilter = document.getElementById('adminFilterDateFrom').value;
            const dateToFilter = document.getElementById('adminFilterDateTo').value;
            
            try {
                let reports = [];
                
                if (isFirebaseConnected) {
                    let query = db.collection('reports').orderBy('submittedDate', 'desc');
                    
                    if (facilityFilter) {
                        query = query.where('facility', '==', facilityFilter);
                    }
                    
                    const snapshot = await query.get();
                    reports = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } else {
                    reports = [...demoReports];
                    if (facilityFilter) {
                        reports = reports.filter(report => report.facility === facilityFilter);
                    }
                }
                
                // Apply date filters
                if (dateFromFilter) {
                    reports = reports.filter(report => report.week >= dateFromFilter);
                }
                
                if (dateToFilter) {
                    reports = reports.filter(report => report.week <= dateToFilter);
                }
                
                displayReports(reports);
                showAlert(`Generated report with ${reports.length} records.`, 'success');
                
            } catch (error) {
                console.error('Generate report error:', error);
                showAlert('Error generating report: ' + error.message, 'error');
            }
        }

        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                return;
            }
            
            try {
                if (isFirebaseConnected) {
                    await db.collection('reports').doc(reportId).delete();
                } else {
                    const reportIndex = demoReports.findIndex(report => report.id === reportId);
                    if (reportIndex > -1) {
                        demoReports.splice(reportIndex, 1);
                    }
                }
                
                loadReports();
                showAlert('Report deleted successfully.', 'warning');
                
            } catch (error) {
                console.error('Delete report error:', error);
                showAlert('Error deleting report: ' + error.message, 'error');
            }
        }

        // Filter functions
        function applyFilters() {
            const weekFilter = document.getElementById('filterWeek').value;
            const commodityFilter = document.getElementById('filterCommodity').value.toLowerCase();
            
            // This is a simple client-side filter for demo
            // In production, you'd want to filter on the server/database level
            const allRows = document.querySelectorAll('#reportsTableBody tr');
            
            allRows.forEach(row => {
                const cells = row.cells;
                if (cells.length <= 1) return; // Skip "no data" rows
                
                const week = cells[0].textContent;
                const commodity = cells[2].textContent.toLowerCase();
                
                let showRow = true;
                
                if (weekFilter && week !== weekFilter) {
                    showRow = false;
                }
                
                if (commodityFilter && !commodity.includes(commodityFilter)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('filterWeek').value = '';
            document.getElementById('filterCommodity').value = '';
            
            // Show all rows
            const allRows = document.querySelectorAll('#reportsTableBody tr');
            allRows.forEach(row => {
                row.style.display = '';
            });
        }

        function refreshReports() {
            loadReports();
            showAlert('Reports refreshed!', 'success');
        }

        // Export function
        function exportData() {
            try {
                // Get current data from table
                const table = document.getElementById('adminReportsTable');
                const rows = table.querySelectorAll('tbody tr');
                
                if (rows.length === 0 || (rows.length === 1 && rows[0].cells.length === 1)) {
                    showAlert('No data to export', 'warning');
                    return;
                }
                
                // Create CSV content
                const headers = ['Week', 'Facility', 'Commodity', 'Expiry Date', 'Opening Balance', 'Received', 'Used', 'Given Out', 'Balance', 'Status', 'Submitted Date', 'Remarks'];
                let csvContent = headers.join(',') + '\n';
                
                rows.forEach(row => {
                    if (row.cells.length > 1) { // Skip "no data" rows
                        const rowData = [];
                        for (let i = 0; i < row.cells.length - 1; i++) { // Skip actions column
                            let cellText = row.cells[i].textContent.trim();
                            // Clean up status badges
                            if (cellText.includes('status-')) {
                                cellText = cellText.replace(/.*status-\w+['"]\s*>/, '').replace(/<.*/, '');
                            }
                            rowData.push(`"${cellText.replace(/"/g, '""')}"`);
                        }
                        csvContent += rowData.join(',') + '\n';
                    }
                });
                
                // Create and download the file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medical_stock_report_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Data exported successfully!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        // Form validation
        function validateForm() {
            const expiryDate = new Date(document.getElementById('expiryDate').value);
            const today = new Date();
            
            if (expiryDate < today) {
                showAlert('Warning: The expiry date is in the past. Please verify this information.', 'warning');
            }
        }

        // Initialize application
        function init() {
            // Don't auto-initialize here, wait for user to proceed from config notice
            console.log('Application ready for initialization');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Add event listeners for balance calculation
            setTimeout(() => {
                calculateBalance();
                
                // Add expiry date validation
                const expiryInput = document.getElementById('expiryDate');
                if (expiryInput) {
                    expiryInput.addEventListener('change', validateForm);
                }
            }, 100);
        });

        // Keyboard shortcuts for admin
        document.addEventListener('keydown', function(e) {
            if (currentUserType === 'admin' && e.ctrlKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        generateAdminReport();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportData();
                        break;
                }
            }
        });
    </script>
</body>
</html>
            
